#include "stm32f10x.h"
#include "BSP_AD9833.h"
#include "BSP_595.h"
void delayt(uint16_t t);
 
 
/********  74HC595 GPIO ?? *************************/
void HC595_GPIO_Config(void)
{
	GPIO_InitTypeDef GPIO_InitStructure;
	//LEDµ∆≈‰÷√
	RCC_APB2PeriphClockCmd( SHCP_LED_CLK | STCP_LED_CLK | DS_LED_CLK, ENABLE);	
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;     
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_2MHz;
	
	GPIO_InitStructure.GPIO_Pin = SHCP_LED_PIN;
	GPIO_Init(SHCP_LED_PORT, &GPIO_InitStructure);   // ??? SHCP ??
	
	GPIO_InitStructure.GPIO_Pin = STCP_LED_PIN;
	GPIO_Init(STCP_LED_PORT, &GPIO_InitStructure);   // ??? STCP ??
	
	GPIO_InitStructure.GPIO_Pin = DS_LED_PIN;
	GPIO_Init(DS_LED_PORT, &GPIO_InitStructure);     // ??? DS   ??
 
	//GPIO_ResetBits(SHCP_GPIO_PORT, SHCP_GPIO_PIN);  // ????????,???????
    GPIO_ResetBits(SHCP_LED_PORT, SHCP_LED_PIN);    // ????????,???????
	GPIO_ResetBits(STCP_LED_PORT, STCP_LED_PIN);	 
	GPIO_ResetBits(DS_LED_PORT, DS_LED_PIN);
	// ˝¬Îπ‹≈‰÷√
	RCC_APB2PeriphClockCmd( SHCP_DTUBE_CLK | STCP_DTUBE_CLK | DS_DTUBE_CLK, ENABLE);	
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;     
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_2MHz;
	
	GPIO_InitStructure.GPIO_Pin = SHCP_DTUBE_PIN;
	GPIO_Init(SHCP_DTUBE_PORT, &GPIO_InitStructure);   // ??? SHCP ??
	
	GPIO_InitStructure.GPIO_Pin = STCP_DTUBE_PIN;
	GPIO_Init(STCP_DTUBE_PORT, &GPIO_InitStructure);   // ??? STCP ??
	
	GPIO_InitStructure.GPIO_Pin = DS_DTUBE_PIN | GPIO_Pin_12;
	GPIO_Init(DS_DTUBE_PORT, &GPIO_InitStructure);     // ??? DS   ??
 
	//GPIO_ResetBits(SHCP_GPIO_PORT, SHCP_GPIO_PIN);  // ????????,???????
    GPIO_ResetBits(SHCP_DTUBE_PORT, SHCP_DTUBE_PIN);    // ????????,???????
	GPIO_ResetBits(STCP_DTUBE_PORT, STCP_DTUBE_PIN);	 
	GPIO_ResetBits(DS_DTUBE_PORT, DS_DTUBE_PIN);
}
/***

*/
void HC595_Send_Byte(uint8_t byte,uint8_t type)
{
	uint8_t i;
	switch(type)
	{
		case 0:
			
			for (i = 0; i < 8; i ++)  //????8?,??8?,????,??8?,????8?
			{
			  /****  ??1:?????DS??    ****/
				if (byte & 0x80)        //?????,????????????1
					LED_Data_High();    //??????1,?? 595 DS??????????
				else                    //???????
					LED_Data_Low();
				
				/*** ??2:SHCP????????,???bit????????? ***/
				LED_SHCP_Low();   // SHCP??
				delayt(1);           // ????
				LED_SHCP_High();  // SHCP??, SHCP?????
				delayt(1);
				
				byte <<= 1;		// ????,???????,??	if (byte & 0x80)???????1
			}
			break;
		case 1:
			for (i = 0; i < 8; i ++)  //????8?,??8?,????,??8?,????8?
			{
			  /****  ??1:?????DS??    ****/
				if (byte & 0x80)        //?????,????????????1-+
					DTUBE_Data_High();    //??????1,?? 595 DS??????????
				else                    //???????
					DTUBE_Data_Low();
				
				/*** ??2:SHCP????????,???bit????????? ***/
				DTUBE_SHCP_Low();   // SHCP??
				delayt(1);           // ????
				DTUBE_SHCP_High();  // SHCP??, SHCP?????
				delayt(1);
				byte <<= 1;		// ????,???????,??	if (byte & 0x80)???????1
			}
			break;
		default:
			break;
	}
}
 

void HC595_CS(uint8_t type) 
{
	switch(type)
	{
		case 0:
			/**  ??3:STCP???????,???????????????  **/
			LED_STCP_Low();   // ?STCP??
			delayt(1);           // ????
			LED_STCP_High();  // ??STCP??,STCP?????????
			delayt(1);
			break;
		case 1:
			/**  ??3:STCP???????,???????????????  **/
			DTUBE_STCP_Low();   // ?STCP??
			delayt(1);           // ????
			DTUBE_STCP_High();  // ??STCP??,STCP?????????
			delayt(1);
			break;
		default:
			break;
	}
}
 

void HC595_Send_Multi_Byte(uint8_t *data, uint8_t len, uint8_t type)
{
	uint8_t i;
	switch(type)
	{
		case 0:
			for (i = 0; i < len; i ++ ) // len ???
			{
				HC595_Send_Byte(data[i],type);
			}
			
			HC595_CS(type); //?????????,?????
			break;
		case 1:
			for (i = 0; i < len; i ++ ) // len ???
			{
				HC595_Send_Byte(data[i],type);
			}
			HC595_CS(type); //?????????,?????
			break;
		default:
			break;
	}
}

void delayt(uint16_t t)
{
	for (; t != 0; t --);
}